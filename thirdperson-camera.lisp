(in-package :thirdperson-controller)

(defparameter *mouse-speed* 5.4)

(defun set-up-camera (camera)
  (let ((eulers (vec3))
        (app (ffi:ref js:pc app))
        (ray-end (find-by-name "RAYCAST-ENDPOINT")))
    (labels ((on-mouse-move (e &rest _)
               (if (eql ((ffi:ref js:pc -mouse is-pointer-locked)) js:true)
                   (progn 
                     (js-setf (eulers x) (- (ffi:ref eulers x)
                                                    (mod (* (* *mouse-speed* (ffi:ref e dx)) 0.01666666) 360))
                              (eulers y) (+ (ffi:ref eulers y) (mod (* (* *mouse-speed* (ffi:ref e dy)) 0.01666666) 360)))
                     (if (< (ffi:ref eulers x) 0)
                         (ffi:set (ffi:ref eulers x) (+ (ffi:ref eulers x) 360)))
                     (if (< (ffi:ref eulers y) 0)
                         (ffi:set (ffi:ref eulers y) (+ (ffi:ref eulers y) 360))))))
             (on-mouse-down (e &rest _)
               ((ffi:ref app mouse enable-pointer-lock)))
             (get-world-point (&rest _)
               (let* ((from ((ffi:ref camera parent get-position)))
                      (to ((ffi:ref ray-end get-position)))
                      (hit-point to)
                      (hit ((ffi:ref app systems rigidbody raycast-first) from to)))
                 (if (not (eql hit js:null))
                     (ffi:ref hit point)
                     to)))
             (p-update (dt &rest _)
               (let* ((origin-entity (ffi:ref camera parent))
                     (target-y (+ (ffi:ref eulers x) 180))
                     (target-x (ffi:ref eulers y))
                     (target-ang (vec3 :x (- target-x) :y target-y)))
                 ((ffi:ref origin-entity set-euler-angles) target-ang)
                 ((ffi:ref camera set-position) (funcall #'get-world-point))
                 ((ffi:ref camera look-at) origin-entity))))
      (on mousemove (ffi:ref app mouse) #'on-mouse-move camera)
      (on mousedown (ffi:ref app mouse) #'on-mouse-down camera)
      (add-to-update :cam #'p-update))))



